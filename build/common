compress() {
    COMPRESS=gzip
    if [ ! -z $(which pigz 2>/dev/null) ]; then
        COMPRESS=pigz
    fi
    $COMPRESS $@
}

is_deb_distro() {
    case $dist in
        centos*)
        DEB=
        ;;
    *)
        DEB=1
    esac
    return $DEB
}


install_ib_if_needed() {
    ORIG=$1
    CHROOT=$2
    if [ "$ENABLE_IB" = "y" ]; then
        bash ${ORIG}/infiniband $CHROOT
        PACKAGES="infiniband-diags"
        DEB=is_deb_distro
        if [ -n "$DEB" ]; then
            chroot "$CHROOT" apt-get -y install $PACKAGES
            RELEASE=$(chroot "$CHROOT" lsb_release -sc)
            if [ "$RELEASE" = "precise" ]; then
                # as per https://bugs.launchpad.net/ubuntu/+source/libmlx4/+bug/1037107
                # ubuntu precise needs a package to be backported
                LIBMLX=libmlx4-1_1.0.4-1_amd64.deb
                cd $CHROOT;
                    wget http://us.archive.ubuntu.com/ubuntu/ubuntu/pool/universe/libm/libmlx4/$LIBMLX
                cd -
                chroot "$CHROOT" dpkg -i /$LIBMLX
                rm -rf $CHROOT/$LIBMLX
            fi
        else
            chroot "$CHROOT" yum --nogpgcheck install -y $PACKAGES
        fi
    fi
}

