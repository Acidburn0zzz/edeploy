#!/bin/bash

BASE="$0"
ROLE="$1"
FROM="$2"
TO="$3"
DEST="$4"

ORIG=$(cd $(dirname $0); pwd)
FDIR=${DEST}/install/${FROM}/${ROLE}
TDIR=${DEST}/install/${TO}/${ROLE}

if [ $# != 4 ]; then
    echo "Usage: $0 <role> <base version> <new version> <top dir>" 1>&2
    exit 1
fi

if [ ! -d "$FDIR" ]; then
    echo "Source directory $FDIR deson't exist" 1>&2
    exit 1
fi

export DEBIAN_FRONTEND=noninteractive

set -x

if [ ! -d ${TDIR} ]; then
    mkdir -p ${TDIR}

    rsync -a --delete ${FDIR}/ ${TDIR}/
fi

cleanup() {
    umount ${TDIR}/dev
}

trap cleanup 0

mount -obind /dev ${TDIR}/dev
chroot ${TDIR} apt-get update
strace -e trace=process -f -o ${ORIG}/upgrade.out.$$ chroot ${TDIR} apt-get dist-upgrade -y
chroot ${TDIR} apt-get clean
cp -p ${ORIG}/edeploy ${TDIR}/usr/sbin/
echo -e "VERS=${TO}\nROLE=${ROLE}\n" > ${TDIR}/var/lib/edeploy/conf
chroot ${TDIR} dpkg -l > ${TDIR}/../${ROLE}.dpkg

script="$BASE".d/${ROLE}_${FROM}_${TO}.upgrade

if [ -x "$script" ]; then
    "$script" $ROLE $FROM $TO $TDIR
fi
